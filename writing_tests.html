

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing Litmus Tests &mdash; system-litmus-harness  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Test Discovery and Linting" href="test_discover.html" />
    <link rel="prev" title="Fixing Runtime Errors" href="debugging_code.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> system-litmus-harness
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging_make.html">Debugging a Failing Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizing_litmus.html">Running the Tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="customizing_make.html">Customizing the Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging_code.html">Fixing Runtime Errors</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Writing Litmus Tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#variables-and-registers">Variables and Registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thread-code-blocks">Thread Code Blocks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#register-and-memory-location-names">Register and Memory Location names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exception-handlers">Exception handlers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#litmus-test-data">Litmus Test Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="test_discover.html">Test Discovery and Linting</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">system-litmus-harness</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Writing Litmus Tests</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/writing_tests.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-litmus-tests">
<h1>Writing Litmus Tests<a class="headerlink" href="#writing-litmus-tests" title="Permalink to this headline">¶</a></h1>
<p>Systems Harness litmus tests are defined in individual C files,
saved under a group directory in <code class="docutils literal notranslate"><span class="pre">litmus/litmus_tests/</span></code>.</p>
<p>Each file contains a series of components that define the Litmus Test in
its entirety:</p>
<ul class="simple">
<li><p>a set of variables that represent chunks of virtual memory</p></li>
<li><p>a set of output registers</p></li>
<li><p>a C function for each thread</p></li>
<li><p>a C function for each thread’s synchronous exception handler, if it has one.</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">litmus_test_t</span></code> declaration for the actual litmus test data.</p></li>
</ul>
<p>Here is an example from <code class="docutils literal notranslate"><span class="pre">litmus_tests/data/MP+pos.c</span></code></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;lib.h&quot;</span><span class="cp"></span>

<span class="cp">#define VARS x, y</span>
<span class="cp">#define REGS p1x0, p1x2</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">P0</span><span class="p">(</span><span class="n">litmus_test_run</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">&quot;mov x0, #1</span><span class="se">\n\t</span><span class="s">&quot;</span>
        <span class="s">&quot;str x0, [%[x]]</span><span class="se">\n\t</span><span class="s">&quot;</span>
        <span class="s">&quot;mov x2, #1</span><span class="se">\n\t</span><span class="s">&quot;</span>
        <span class="s">&quot;str x2, [%[y]]</span><span class="se">\n\t</span><span class="s">&quot;</span>
    <span class="o">:</span>
    <span class="o">:</span> <span class="n">ASM_VARS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">VARS</span><span class="p">),</span>
        <span class="n">ASM_REGS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">REGS</span><span class="p">)</span>
    <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;x0&quot;</span><span class="p">,</span> <span class="s">&quot;x2&quot;</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">P1</span><span class="p">(</span><span class="n">litmus_test_run</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">&quot;ldr x0, [%[y]]</span><span class="se">\n\t</span><span class="s">&quot;</span>
        <span class="s">&quot;ldr x2, [%[x]]</span><span class="se">\n\t</span><span class="s">&quot;</span>

        <span class="s">&quot;str x0, [%[outp1r0]]</span><span class="se">\n\t</span><span class="s">&quot;</span>
        <span class="s">&quot;str x2, [%[outp1r2]]</span><span class="se">\n\t</span><span class="s">&quot;</span>
    <span class="o">:</span>
    <span class="o">:</span> <span class="n">ASM_VARS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">VARS</span><span class="p">),</span>
        <span class="n">ASM_REGS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">REGS</span><span class="p">)</span>
    <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;x0&quot;</span><span class="p">,</span> <span class="s">&quot;x2&quot;</span>
    <span class="p">);</span>
<span class="p">}</span>


<span class="n">litmus_test_t</span> <span class="n">MP_pos</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;MP+pos&quot;</span><span class="p">,</span>
    <span class="n">MAKE_THREADS</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">MAKE_VARS</span><span class="p">(</span><span class="n">VARS</span><span class="p">),</span>
    <span class="n">MAKE_REGS</span><span class="p">(</span><span class="n">REGS</span><span class="p">),</span>
    <span class="n">INIT_STATE</span><span class="p">(</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="p">.</span><span class="n">interesting_result</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">uint64_t</span><span class="p">[]){</span>
        <span class="cm">/* p1:x0 =*/</span> <span class="mi">1</span><span class="p">,</span>
        <span class="cm">/* p1:x2 =*/</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">.</span><span class="n">no_sc_results</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="variables-and-registers">
<h2>Variables and Registers<a class="headerlink" href="#variables-and-registers" title="Permalink to this headline">¶</a></h2>
<p>Each file contains a define macro for the set of memory locations and output registers.
These are used in multiple places to aid in the definition of the litmus test file itself.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define VARS x, y
#define REGS p1x0, p1x2
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">VARS</span></code> is a comma-separated list of memory locations, and can be named anything.
<code class="docutils literal notranslate"><span class="pre">REGS</span></code> is a comma-separated list of output registers and must have the form pNr
where X=the thread, where 0 is the first thread and r is the register (e.g. x0-x30).</p>
</div>
<div class="section" id="thread-code-blocks">
<h2>Thread Code Blocks<a class="headerlink" href="#thread-code-blocks" title="Permalink to this headline">¶</a></h2>
<p>Each thread is defined by a single C function,  typically named P0-Pn.
This C function is executed on each loop at EL0,  and is passed a single argument
which contains all the data available to the test.</p>
<p>In the following snippet is an example defining Thread#3 (aka P2) and its exception handler.</p>
<div class="section" id="register-and-memory-location-names">
<h3>Register and Memory Location names<a class="headerlink" href="#register-and-memory-location-names" title="Permalink to this headline">¶</a></h3>
<p>Inside the asm block, the <code class="docutils literal notranslate"><span class="pre">ASM_VARS</span></code> macro makes the memory locations accessible inside the asm code,
as named identifiers in the way they were defined in the <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">VARS</span></code> declaration.
The <code class="docutils literal notranslate"><span class="pre">ASM_REGS</span></code> macro makes the name <code class="docutils literal notranslate"><span class="pre">outpNrM</span></code> available for register <code class="docutils literal notranslate"><span class="pre">pNxM</span></code> in the asm block.
Note that the set of clobbers x0-x10 are required, and the linter (see <a class="reference internal" href="test_discover.html"><span class="doc">Test Discovery and Linting</span></a>) should check them
if it can.</p>
</div>
<div class="section" id="exception-handlers">
<h3>Exception handlers<a class="headerlink" href="#exception-handlers" title="Permalink to this headline">¶</a></h3>
<p>Here P2 has an exception handler,  there is no restriction on the names of the handler and it is called <code class="docutils literal notranslate"><span class="pre">P2_sync_handler</span></code> in this example.
It will be executed for any synchronous exception from the designated exception level (defined in the <code class="docutils literal notranslate"><span class="pre">litmus_test_t</span></code> declaration, see below).
It <strong>must</strong> contain an <code class="docutils literal notranslate"><span class="pre">eret</span></code> instruction.</p>
<p>This example uses the <code class="docutils literal notranslate"><span class="pre">ERET_TO_NEXT(r)</span></code> macro which ensures it performs an <code class="docutils literal notranslate"><span class="pre">eret</span></code> to the instruction after the one that caused the exception,
allowing the test to continue.  This macro clobbers register <code class="docutils literal notranslate"><span class="pre">r</span></code> in the process, and so it must be included in the list of clobbers in the asm block
(note how that this example includes “x10” in the clobbers).  As before, linters should check this if they can.</p>
</div>
</div>
<div class="section" id="litmus-test-data">
<h2>Litmus Test Data<a class="headerlink" href="#litmus-test-data" title="Permalink to this headline">¶</a></h2>
<p>The final <code class="docutils literal notranslate"><span class="pre">litmus_test_t</span></code> declaration contains the actual data of the litmus test that
is loaded when the tool starts.</p>
<p>It contains the following information:</p>
<ul class="simple">
<li><p>the litmus test name.</p></li>
<li><p>the set of threads.</p></li>
<li><p>the set of variables/memory locations.</p></li>
<li><p>the set of output registers.</p></li>
<li><p>the exception handlers for each thread.</p></li>
<li><dl class="simple">
<dt>the initial state, which is one of the following:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">INIT_VAR(x,</span> <span class="pre">v)</span></code> to set the initial value of memory location <code class="docutils literal notranslate"><span class="pre">x</span></code> to <code class="docutils literal notranslate"><span class="pre">v</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INIT_PTE(x,</span> <span class="pre">p)</span></code> to set the initial descriptor of <code class="docutils literal notranslate"><span class="pre">x</span></code> in the pagetable to <code class="docutils literal notranslate"><span class="pre">p</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INIT_UNMAPPED(x)</span></code> to ensure the memory location <code class="docutils literal notranslate"><span class="pre">x</span></code> starts out unmapped and accesses to it generate translation faults.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>the interesting result(s) to flag up in the final output.</p></li>
<li><p>the number of non-interesting results, for sanity checking.</p></li>
</ul>
<p>The actual C variable name of the <code class="docutils literal notranslate"><span class="pre">litmus_test_t</span></code> object is not used, but must be a unique C identifier.</p>
<p>An example that uses all the above features is given below, with comments:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">litmus_test_t</span> <span class="n">BBM1_dmblddsbtlbiisdmblddsbdsb_dsbisb</span> <span class="o">=</span> <span class="p">{</span>

  <span class="cm">/** the name of the litmus test as it will be used and displayed</span>
<span class="cm">   * by the litmus.exe tool</span>
<span class="cm">   */</span>
  <span class="s">&quot;MP.BBM1+[dmb.ld]-dsb-tlbiis-[dmb.ld]-dsb-dsb+dsb-isb&quot;</span><span class="p">,</span>

  <span class="cm">/** this test has 3 threads, and uses the VARS and REGS macros defined earlier</span>
<span class="cm">   */</span>
  <span class="n">MAKE_THREADS</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
  <span class="n">MAKE_VARS</span><span class="p">(</span><span class="n">VARS</span><span class="p">),</span>
  <span class="n">MAKE_REGS</span><span class="p">(</span><span class="n">REGS</span><span class="p">),</span>

  <span class="cm">/** there are 5 initial state entries and they are:</span>
<span class="cm">   * x starts unmapped</span>
<span class="cm">   * y starts as 0</span>
<span class="cm">   * z starts as 1</span>
<span class="cm">   * a starts as 0</span>
<span class="cm">   * b starts as 0</span>
<span class="cm">   */</span>
  <span class="n">INIT_STATE</span><span class="p">(</span>
      <span class="mi">5</span><span class="p">,</span>
      <span class="n">INIT_UNMAPPED</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
      <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
      <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
  <span class="p">),</span>

  <span class="cm">/** there are 2 interesting results</span>
<span class="cm">   * the case where p0x2=1, p0x7=1, p1x0=1, p1x2=0</span>
<span class="cm">   * and the case where p0x2=1, p0x7=1, p1x0=1, p1x2=2</span>
<span class="cm">   *</span>
<span class="cm">   * note that the registers in the result appear in the order of the #VARS declaration.</span>
<span class="cm">   */</span>
  <span class="p">.</span><span class="n">no_interesting_results</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
  <span class="p">.</span><span class="n">interesting_results</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">[]){</span>
      <span class="p">(</span><span class="kt">uint64_t</span><span class="p">[]){</span>
      <span class="cm">/* p0:x2 =*/</span><span class="mi">1</span><span class="p">,</span>
      <span class="cm">/* p0:x7 =*/</span><span class="mi">1</span><span class="p">,</span>
      <span class="cm">/* p1:x0 =*/</span><span class="mi">1</span><span class="p">,</span>
      <span class="cm">/* p1:x2 =*/</span><span class="mi">0</span><span class="p">,</span>  <span class="cm">/* stale translation */</span>
      <span class="p">},</span>
      <span class="p">(</span><span class="kt">uint64_t</span><span class="p">[]){</span>
      <span class="cm">/* p0:x2 =*/</span><span class="mi">1</span><span class="p">,</span>
      <span class="cm">/* p0:x7 =*/</span><span class="mi">1</span><span class="p">,</span>
      <span class="cm">/* p1:x0 =*/</span><span class="mi">1</span><span class="p">,</span>
      <span class="cm">/* p1:x2 =*/</span><span class="mi">2</span><span class="p">,</span>  <span class="cm">/* spurious abort */</span>
      <span class="p">},</span>
  <span class="p">},</span>

  <span class="cm">/** thread 0 starts at EL1</span>
<span class="cm">   * all other threads start at EL0</span>
<span class="cm">   */</span>
  <span class="p">.</span><span class="n">start_els</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span><span class="p">[]){</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>

  <span class="cm">/** Threads 0 and 2 do not have any exception handlers setup</span>
<span class="cm">   * and so any exception will abort the test.</span>
<span class="cm">   *</span>
<span class="cm">   * Thread 1 has an exception handler for exceptions from EL0,</span>
<span class="cm">   * but not from EL1.  So exceptions in Thread 1 from EL1 will abort the test.</span>
<span class="cm">   * Exceptions in Thread 1 from EL0 will run the sync_handler function</span>
<span class="cm">   */</span>
  <span class="p">.</span><span class="n">thread_sync_handlers</span> <span class="o">=</span>
      <span class="p">(</span><span class="kt">uint32_t</span><span class="o">**</span><span class="p">[]){</span>
      <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">[]){</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
      <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">[]){(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">sync_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
      <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">[]){</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
      <span class="p">},</span>

  <span class="cm">/** this test requires the MMU to be enabled</span>
<span class="cm">   * and hence requires the --pgtable option to be passed</span>
<span class="cm">   */</span>
  <span class="p">.</span><span class="n">requires_pgtable</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>

  <span class="cm">/** there are 14 other uninteresting results</span>
<span class="cm">   *</span>
<span class="cm">   * the harness will check that the total number of results it saw for this test was the 2</span>
<span class="cm">   * interesting ones, and exactly 14 distinct other results.</span>
<span class="cm">   *</span>
<span class="cm">   * if it sees fewer or more, it will emit an warning e.g.</span>
<span class="cm">   * e.g. &quot;Warning on MP.BBM1+[dmb.ld]-dsb-tlbiis-[dmb.ld]-dsb-dsb+dsb-isb: saw 5 SC results but expected 14&quot;</span>
<span class="cm">   */</span>
  <span class="p">.</span><span class="n">no_sc_results</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="test_discover.html" class="btn btn-neutral float-right" title="Test Discovery and Linting" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="debugging_code.html" class="btn btn-neutral float-left" title="Fixing Runtime Errors" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Ben Simner,  Ohad Kammar

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>