

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Test Discovery and Linting &mdash; system-litmus-harness  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Writing Litmus Tests" href="writing_tests.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> system-litmus-harness
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging_make.html">Debugging a Failing Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="customizing_litmus.html">Running the Tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="customizing_make.html">Customizing the Build</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging_code.html">Fixing Runtime Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing_tests.html">Writing Litmus Tests</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Test Discovery and Linting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#discovery">Discovery</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#group-and-test-lists">Group and test lists</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#groups-c">groups.c</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linting">Linting</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">system-litmus-harness</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Test Discovery and Linting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/test_discover.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="test-discovery-and-linting">
<h1>Test Discovery and Linting<a class="headerlink" href="#test-discovery-and-linting" title="Permalink to this headline">¶</a></h1>
<p>When compiling the binary the makefile will try detect litmus tests and
collect any new ones.</p>
<div class="section" id="discovery">
<h2>Discovery<a class="headerlink" href="#discovery" title="Permalink to this headline">¶</a></h2>
<p>By default the tool responsible is a small Python script located at <code class="docutils literal notranslate"><span class="pre">litmus/makegroups.py</span></code>.</p>
<p>This file will read all the <code class="docutils literal notranslate"><span class="pre">.c</span></code> files under <code class="docutils literal notranslate"><span class="pre">litmus/litmus_tests/</span></code> and build 3 files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">litmus/test_list.txt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">litmus/group_list.txt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">litmus/groups.c</span></code></p></li>
</ul>
<div class="section" id="group-and-test-lists">
<h3>Group and test lists<a class="headerlink" href="#group-and-test-lists" title="Permalink to this headline">¶</a></h3>
<p>The group list contains the <code class="docutils literal notranslate"><span class="pre">LITMUS_TESTS</span></code> argument from the run of the Makefile.
This means repeated executions of the Makefile remembers the old setting.</p>
<p>The test listing contains a file like the one below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0 litmus/litmus_tests/amo/MP+po_p_amoswap_pl-coi+addr.c 1594228641.6208193 MP_pos AArch64 MP+po_p_amoswap_pl-coi+addr all amo
1 litmus/litmus_tests/checks/check4.c 1590352298.4354115 check4 check4 all checks
1 litmus/litmus_tests/checks/check3.c 1590339837.875848 check3 check3 all checks
1 litmus/litmus_tests/checks/check2.c 1590339935.373299 check2 check2 all checks
1 litmus/litmus_tests/checks/check6.c 1590421869.2080476 check6 check6 all checks
1 litmus/litmus_tests/checks/check1.c 1590339787.7471209 check1 check1 all checks
1 litmus/litmus_tests/checks/check5.c 1592996319.996931 check5 check5 all checks
1 litmus/litmus_tests/pgtable/WRC.TRR+addr+dmb.c 1594290381.603 WRCtrr_addr_dmb WRC.TRR+addr+dmb all pgtable
</pre></div>
</div>
<p>Each line is a record, and a record is made from whitespace separated fields.
The fields are, in-order:</p>
<ul class="simple">
<li><p>Whether the test is currently enabled and is compiled each time (1=yes, 0=no).</p></li>
<li><p>the source file that contains the test</p></li>
<li><p>the last modified timestamp</p></li>
<li><p>the name of the litmus test</p></li>
<li><p>the groups it belongs to</p></li>
</ul>
<p>There may be many groups (in general, at least 2) for a test and so the records are not a fixed number of fields.</p>
<p>This list is mostly useful for bookkeeping,  allowing the file to check for new tests that
weren’t detected last time, or for collection of results from devices (TODO).</p>
</div>
</div>
<div class="section" id="groups-c">
<h2>groups.c<a class="headerlink" href="#groups-c" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">groups.c</span></code> file contains some C declarations of the test lists and group lists,
so they can be read at runtime on the remote device for parsing command-line args.</p>
<p>An example <code class="docutils literal notranslate"><span class="pre">groups.c</span></code> is given below for <code class="docutils literal notranslate"><span class="pre">LITMUS_TESTS=&#64;data</span></code></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/************************</span>
<span class="cm">*  AUTOGENERATED FILE  *</span>
<span class="cm">*     DO NOT EDIT      *</span>
<span class="cm">************************/</span>

<span class="cm">/* this file was generated with the following command:</span>
<span class="cm">* `make LITMUS_TESTS=&#39;@data&#39;`</span>
<span class="cm">*</span>
<span class="cm">* please re-run that command to re-generate this file</span>
<span class="cm">*/</span>
<span class="cp">#include</span> <span class="cpf">&quot;lib.h&quot;</span><span class="cp"></span>

<span class="k">extern</span> <span class="n">litmus_test_t</span>
  <span class="n">LB_pos</span><span class="p">,</span>
  <span class="n">MP_dmbs</span><span class="p">,</span>
  <span class="n">MP_pos</span><span class="p">,</span>
  <span class="n">SB_dmbs</span><span class="p">,</span>
  <span class="n">SB_pos</span><span class="p">,</span>
  <span class="n">WRC_addrs</span><span class="p">,</span>
  <span class="n">WRC_pos</span><span class="p">;</span>


<span class="k">const</span> <span class="n">litmus_test_group</span> <span class="n">grp_data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;@data&quot;</span><span class="p">,</span>
  <span class="p">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">litmus_test_t</span><span class="o">*</span><span class="p">[]){</span>
    <span class="o">&amp;</span><span class="n">LB_pos</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">MP_dmbs</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">MP_pos</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">SB_dmbs</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">SB_pos</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">WRC_addrs</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">WRC_pos</span><span class="p">,</span>
    <span class="nb">NULL</span>
  <span class="p">},</span>
  <span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">litmus_test_group</span><span class="o">*</span><span class="p">[]){</span>
    <span class="nb">NULL</span>
  <span class="p">},</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">litmus_test_group</span> <span class="n">grp_all</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;@all&quot;</span><span class="p">,</span>
  <span class="p">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">litmus_test_t</span><span class="o">*</span><span class="p">[]){</span>
    <span class="nb">NULL</span>
  <span class="p">},</span>
  <span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">litmus_test_group</span><span class="o">*</span><span class="p">[]){</span>
    <span class="o">&amp;</span><span class="n">grp_data</span><span class="p">,</span>
    <span class="nb">NULL</span>
  <span class="p">},</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">litmus_test_t</span></code> declarations just bring all the C identifiers for the <code class="docutils literal notranslate"><span class="pre">litmus_test_t</span></code> declarations into scope
to squash warnings, then a group <code class="docutils literal notranslate"><span class="pre">&#64;groupName</span></code> is defined by a C declaration <code class="docutils literal notranslate"><span class="pre">grp_groupName</span></code>.</p>
<p>Each <code class="docutils literal notranslate"><span class="pre">litmus_test_group</span></code> has 3 parts:</p>
<ul class="simple">
<li><p>a &#64;name</p></li>
<li><p>a NULL-terminated list of <code class="docutils literal notranslate"><span class="pre">litmus_test_t</span></code> s</p></li>
<li><p>a NULL-terminated list of <code class="docutils literal notranslate"><span class="pre">litmus_test_group</span></code> s</p></li>
</ul>
</div>
<div class="section" id="linting">
<h2>Linting<a class="headerlink" href="#linting" title="Permalink to this headline">¶</a></h2>
<p>During compilation a small ‘linter’ script runs over the litmus tests files.
This linter script is intended to just detect mistakes in the source that
can easily be done when writing the litmus tests, but are still valid C.</p>
<p>Below is an example of an intentionally badly written litmus test:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;lib.h&quot;</span><span class="cp"></span>

<span class="cp">#define VARS x, y, z</span>
<span class="cp">#define REGS p0x2</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span>
    <span class="s">&quot;mov x2, #0</span><span class="se">\n\t</span><span class="s">&quot;</span>

    <span class="n">ERET_TO_NEXT</span><span class="p">(</span><span class="n">x10</span><span class="p">)</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">P0</span><span class="p">(</span><span class="n">litmus_test_run</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">asm</span> <span class="k">volatile</span> <span class="p">(</span>
    <span class="cm">/* move from C vars into machine regs */</span>
      <span class="s">&quot;mov x0, %[ydesc]</span><span class="se">\n\t</span><span class="s">&quot;</span>
      <span class="s">&quot;mov x1, %[xpte]</span><span class="se">\n\t</span><span class="s">&quot;</span>
      <span class="s">&quot;mov x3, %[x]</span><span class="se">\n\t</span><span class="s">&quot;</span>
      <span class="s">&quot;mov x6, #42</span><span class="se">\n\t</span><span class="s">&quot;</span>

      <span class="cm">/* test */</span>
      <span class="s">&quot;str x0, [x1]</span><span class="se">\n\t</span><span class="s">&quot;</span>
      <span class="s">&quot;ldr x2, [x3]</span><span class="se">\n\t</span><span class="s">&quot;</span>

      <span class="cm">/* output */</span>
      <span class="s">&quot;str x2, [%[outp0r2]]</span><span class="se">\n\t</span><span class="s">&quot;</span>
  <span class="o">:</span>
  <span class="o">:</span> <span class="n">ASM_VARS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">VARS</span><span class="p">),</span>
    <span class="n">ASM_REGS</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">REGS</span><span class="p">)</span>
  <span class="o">:</span> <span class="s">&quot;cc&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span> <span class="s">&quot;x0&quot;</span><span class="p">,</span> <span class="s">&quot;x2&quot;</span><span class="p">,</span> <span class="s">&quot;x3&quot;</span>
  <span class="p">);</span>
<span class="p">}</span>


<span class="n">litmus_test_t</span> <span class="n">CoWTinv</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">&quot;CoWT+wrong-name.inv&quot;</span><span class="p">,</span>
  <span class="n">MAKE_THREADS</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
  <span class="n">MAKE_VARS</span><span class="p">(</span><span class="n">VARS</span><span class="p">),</span>
  <span class="n">MAKE_REGS</span><span class="p">(</span><span class="n">REGS</span><span class="p">),</span>
  <span class="n">INIT_STATE</span><span class="p">(</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="n">INIT_UNMAPPED</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
    <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">INIT_VAR</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">),</span>
  <span class="p">.</span><span class="n">interesting_result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">[]){</span>
    <span class="cm">/* p0:x2 =*/</span><span class="mi">0</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="p">.</span><span class="n">thread_sync_handlers</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="o">**</span><span class="p">[]){</span>
    <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">[]){(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">sync_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
    <span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">[]){(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">sync_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
  <span class="p">},</span>
  <span class="p">.</span><span class="n">no_sc_results</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Running the linter on this file reveals the following issues:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ python3 litmus/linter.py litmus/litmus_tests/pgtable/CoWT.inv.c
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: File name and Litmus name mismatch.
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: Thread count mismatch.
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: Thread count does not match number of exception handler entries.
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: clobber missing register x1 in Thread 0
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: clobber missing register x10 in Thread 0
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: clobber missing register x6 in Thread 0
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: register x6 in Thread 0 appears to be unused
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: initial state contains 3 states but INIT_STATE arguments claim it has 2 states
! [litmus/litmus_tests/pgtable/CoWT.inv.c] Warning: missing requires_pgtable=1?
</pre></div>
</div>
<p>Linting can be totally disabled by running make with <code class="docutils literal notranslate"><span class="pre">NO_LINT=1</span></code>.
Or the linter command can be customized by running make with <code class="docutils literal notranslate"><span class="pre">LINTER='custom</span> <span class="pre">cmd'</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="writing_tests.html" class="btn btn-neutral float-left" title="Writing Litmus Tests" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Ben Simner,  Ohad Kammar

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>